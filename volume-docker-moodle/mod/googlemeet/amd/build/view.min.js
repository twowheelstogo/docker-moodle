define ("mod_googlemeet/view",["core/ajax","core/str","core/notification","core/templates","mod_googlemeet/gapi"],function(a,b,c,d,e){return{init:function init(f,g,h,i,j,k){var w=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],x=h.url.substr(24,12),y,z="",A="",B="",C="";b.get_strings([{key:"notpossiblesync",component:"mod_googlemeet"},{key:"notfoundrecordingsfolder",component:"mod_googlemeet"},{key:"notfoundrecordingname",component:"mod_googlemeet"},{key:"or",component:"mod_googlemeet"}]).done(function(a){z=a[0];A=a[1];B=a[2];C=a[3]}).fail(c.exception);var D=document.getElementById("id_syncdrivebutton");function l(){e.auth2.getAuthInstance().signIn({prompt:"select_account"}).then(function(){v()}).catch()}function m(a){var b=document.getElementById("googlemeet_syncimg");if(a){b.style.display="flex";D.disabled=!0}else{b.style.display="none";D.disabled=!1}}function n(a){var b=document.getElementById("googlemeetcontentlog"),c=document.createTextNode(a+"\n");b.style.display="block";b.appendChild(c)}function o(){var a=document.getElementById("googlemeetcontentlog");a.style.display="none";a.innerHTML=""}function p(a){e.client.drive.permissions.create({resource:{type:"anyone",role:"reader"},fileId:a,fields:"id"}).then().catch()}function q(){var a="and (name contains '"+x+"'";a+=" or name contains '"+h.originalname+"')";return a}function r(a){var b=Math.floor(parseInt(a,10)/1e3),c=Math.floor(b/3600),d=Math.floor((b-3600*c)/60),e=b-3600*c-60*d;if(10>e){e="0"+e}if(0<c){if(10>d){d="0"+d}return c+":"+d+":"+e}else{return d+":"+e}}function s(a){d.render("mod_googlemeet/recordingstable",{recordings:a,coursemoduleid:j,hascapability:k}).then(function(a,b){m(!1);d.replaceNodeContents("#googlemeet_recordings_table",a,b);document.getElementById("id_creatoremail").innerHTML=y;document.getElementById("id_lastsync").innerHTML=new Date().toLocaleString().substr(0,16)}).fail(c.exception).fail(function(){m(!1)})}function t(b){e.client.drive.files.list({q:"("+b+") and trashed=false and mimeType='video/mp4' "+q(),pageSize:1e3,fields:"files(id,name,permissionIds,createdTime,videoMediaMetadata,webViewLink)"}).then(function(b){var d=b.result.files;if(d&&0<d.length){for(var e=0,f;e<d.length;e++){f=d[e];if(!f.permissionIds.includes("anyoneWithLink")){p(f.id)}d[e].recordingId=f.id;d[e].duration=r(f.videoMediaMetadata.durationMillis);d[e].createdTime=Math.floor(new Date(f.createdTime).getTime()/1e3);delete d[e].id;delete d[e].permissionIds;delete d[e].videoMediaMetadata}a.call([{methodname:"mod_googlemeet_sync_recordings",args:{googlemeetid:h.id,creatoremail:y,files:d,coursemoduleid:j}}])[0].then(function(a){s(a);i=!0}).fail(c.exception).fail(function(){m(!1)})}else{var g=B+" \""+x+"\" ";if(h.originalname){g+=C+" \""+h.originalname+"\""}n(g);m(!1);if(i){m(!0);a.call([{methodname:"mod_googlemeet_delete_all_recordings",args:{googlemeetid:h.id,coursemoduleid:j}}])[0].then(function(a){s(a);i=!1;m(!1)}).fail(c.exception).fail(function(){m(!1)})}}}).catch(function(a){m(!1);n(JSON.stringify(a.result.error,null,2))})}function u(a,b){for(var c=0;c<b.length;c++){if(!0===b[c].me){return a===b[c].emailAddress}}return!1}function v(){m(!0);o();e.client.drive.files.list({q:"name='Meet Recordings' and trashed=false",pageSize:1e3,fields:"nextPageToken, files(id,owners)"}).then(function(a){var b=a.result.files;if(b&&0<b.length){for(var c="",d=0;d<b.length;d++){if(u(h.creatoremail,b[d].owners)){y=h.creatoremail;c+="parents='".concat(b[d].id,"'");if(d+1<b.length){c+=" or "}}}if(c){t(c);return}n(z);m(!1)}else{n(A);m(!1)}}).catch(function(a){m(!1);n(JSON.stringify(a.result.error,null,2))})}e.load("client:auth2",function(){e.client.init({apiKey:g,clientId:f,discoveryDocs:w,scope:"https://www.googleapis.com/auth/drive"}).then(function(){D.onclick=l;D.disabled=!1}).catch(function(a){D.disabled=!0;n(JSON.stringify(a,null,2))})})}}});
//# sourceMappingURL=view.min.js.map
